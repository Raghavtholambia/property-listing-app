<%- include('./components/header.ejs') %>
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= clickListing.itemName %> | Rental</title>
  <style>
    /* fade-in animation */
    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* remove blocky look */
body {
  background-color: #fafafa; /* bright clean bg */
  font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
  color: #333;
}

.container-fluid {
  padding-left: 2rem;
  padding-right: 2rem;
}

.plain-box {
  background: #fff;
  padding: 2rem;
  margin-bottom: 2rem;
  border-radius: 16px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
}
    .image-full { width: 100%; text-align: center; margin-bottom: 1rem; }
    .image-full img {
      width: 100%; height: 200px; max-height: 70vh;
      object-fit: contain; 
      border-radius: 16px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }

    #upload-loader {
      position: fixed; top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 255, 255, 0.8);
      z-index: 9999;
      display: flex; align-items: center; justify-content: center;
    }
    .spinner {
      width: 50px; height: 50px;
      border: 6px solid #ccc; border-top: 6px solid crimson;
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

    .star-rating { display: flex; flex-direction: row-reverse; justify-content: flex-end; }
    .star-rating input { display: none; }
    .star-rating label {
      font-size: 2rem; color: #ccc; cursor: pointer; transition: color 0.2s;
    }
    .star-rating input:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label { color: #f39c12; }

h2, h4 {
  font-weight: 600;
  color: #222;
}

p {
  line-height: 1.6;
  font-size: 1rem;
  color: #555;
}

#map {
  width: 100%;
  height: 400px;
  border-radius: 16px;
  margin-top: 1rem;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
}
  </style>
</head>

  <body class="bg-light">
  <div id="upload-loader" style="display: none;">
    <div class="spinner"></div>
  </div>

  <div class="container-fluid py-4 fade-in">
    <div class="row justify-content-center">
      <div class="col-12 col-md-10 col-lg-8">

        <div class="plain-box">
          <!-- Image -->
          <div class="image-full">
            <img src="<%= clickListing.image.url %>" alt="Listing Image">
          </div>

          <!-- Item Name -->
          <h2 class="h3 mb-2">
            <i class="bi bi-box-seam me-2"></i>
            <%= clickListing.itemName %>
          </h2>

          <!-- Category -->
          <p class="text-muted small mb-1">
            Category: <strong><%= clickListing.category %></strong>
          </p>

          <!-- Owner -->
          <p class="text-muted small mb-2">
            Owned by: <strong><%= clickListing.owner.username  %></strong>
          </p>

          <!-- Location -->
          <p><b>Location:</b> <%= clickListing.city %>, <%= clickListing.country %></p>

          <!-- Description -->
          <p><b>Description:</b> <%= clickListing.description %></p>

          <!-- Price -->
          <p class="h4 text-danger">₹ <%= clickListing.pricePerDay %> / day</p>
          <!-- Rental Form -->
  <% if (currUser && currUser.role==='user' ) { %>
    <div class="mt-4 p-3 bg-white rounded shadow-sm fade-in">
      <h4><i class="bi bi-calendar-check me-2"></i> Rent This Item</h4>
<form id="rentForm" action="/cart/add/<%= clickListing._id %>" method="POST">
  
  <!-- Dates -->
  <div class="row mb-3">
    <div class="col-md-6">
      <label for="startDate" class="form-label">Start Date</label>
      <input type="date" id="startDate" name="startDate" class="form-control" required>
    </div>
    <div class="col-md-6">
      <label for="endDate" class="form-label">End Date</label>
      <input type="date" id="endDate" name="endDate" class="form-control" required>
    </div>
  </div>

  <!-- Quantity -->
  <div class="mb-3">
    <label class="form-label">Quantity</label>
    <div class="input-group" style="max-width: 160px;">
      <button type="button" class="btn btn-outline-secondary" id="decreaseQty">-</button>
      <input type="number" id="quantity" name="quantity" value="1" min="1" class="form-control text-center" readonly>
      <button type="button" class="btn btn-outline-secondary" id="increaseQty">+</button>
    </div>
  </div>

  <!-- Total Price -->
  <div class="mb-3">
    <p class="h5">Total Price: <span id="totalPrice">₹0</span></p>
  </div>

  <!-- Submit -->
  <button type="submit" class="btn btn-warning w-100">Add to Cart</button>
</form>



    </div>
  <% } %>

  <script>
    const pricePerDay = <%= clickListing.pricePerDay %>;
    const qtyInput = document.getElementById("quantity");
    const startDate = document.getElementById("startDate");
    const endDate = document.getElementById("endDate");
    const totalPriceEl = document.getElementById("totalPrice");

    function calculateTotal() {
      const qty = parseInt(qtyInput.value) || 1;
      const start = new Date(startDate.value);
      const end = new Date(endDate.value);

      let days = 0;
      if (startDate.value && endDate.value && end >= start) {
        days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1; // inclusive
      }
      const total = pricePerDay * qty * days;
      totalPriceEl.textContent = `₹${total > 0 ? total : 0}`;
    }

    // Quantity buttons
    document.getElementById("increaseQty").addEventListener("click", () => {
      qtyInput.value = parseInt(qtyInput.value) + 1;
      calculateTotal();
    });
    document.getElementById("decreaseQty").addEventListener("click", () => {
      if (parseInt(qtyInput.value) > 1) {
        qtyInput.value = parseInt(qtyInput.value) - 1;
        calculateTotal();
      }
    });

    // Recalculate when dates change
    startDate.addEventListener("change", calculateTotal);
    endDate.addEventListener("change", calculateTotal);
  </script>
          <!-- Owner/Admin Buttons -->
          <% if (currUser && (currUser._id.equals(clickListing.owner._id) || currUser.role==='admin')) { %>
            <div class="D">
              <a href="/listing/<%= clickListing._id %>/edit" class="btn btn-outline-primary">
                <i class="bi bi-pencil-square"></i> Edit
              </a>
              <form id="uploadForm" action="/listing/<%= clickListing._id %>?_method=DELETE" method="POST"
                class="d-inline" onsubmit="return confirm('Delete this listing?');">
                <button class="btn btn-outline-danger">
                  <i class="bi bi-trash-fill"></i> Delete
                </button>
              </form>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>


  <!-- Ratings Summary -->
  <div class="plain-box fade-in mb-4">
    <h4><i class="bi bi-star-fill text-warning me-2"></i>Ratings & Reviews</h4>
    <div class="d-flex align-items-center mb-3">
      <h1 class="me-3"><%= avgRating.toFixed(1)  || "0.0" %>★</h1>
      <div><p class="mb-0 text-muted"><%= clickListing.reviews.length %> Reviews</p></div>
    </div>

    <% [5,4,3,2,1].forEach(star => { 
      const count = clickListing.reviews.filter(r => r.rating === star).length;
      const percent = clickListing.reviews.length 
        ? (count / clickListing.reviews.length * 100).toFixed(1) 
        : 0;
    %>
      <div class="d-flex align-items-center mb-1">
        <span class="me-2"><%= star %>★</span>
        <div class="progress flex-grow-1" style="height: 6px;">
          <div class="progress-bar bg-warning" role="progressbar" style="width: <%= percent %>%"></div>
        </div>
        <span class="ms-2"><%= count %></span>
      </div>
    <% }) %>
  </div>

  <!-- Review Form -->
  <% if (currUser) { %>
    <div class="plain-box fade-in">
      <h4><i class="bi bi-chat-square-text me-2"></i>Leave a Review</h4>
      <form action="/listing/<%= clickListing._id %>/reviews" method="POST">
        <div class="mb-3">
          <label class="form-label">Rating</label>
          <div class="star-rating">
            <% for (let i = 5; i >= 1; i--) { %>
              <input type="radio" id="star<%= i %>" name="review[rating]" value="<%= i %>" required />
              <label for="star<%= i %>" title="<%= i %> stars">&#9733;</label>
            <% } %>
          </div>
        </div>
        <div class="mb-3">
          <label for="comments" class="form-label">Comments</label>
          <textarea id="comments" name="review[comments]" class="form-control" rows="4"
            placeholder="Write your review..." required></textarea>
        </div>
        <button type="submit" class="btn btn-success">
          <i class="bi bi-send-fill me-1"></i> Submit
        </button>
      </form>
    </div>
  <% } %>

  <!-- All Reviews -->
  <div class="plain-box fade-in">
    <h4><i class="bi bi-chat-dots-fill me-2"></i>User Reviews</h4>
    <ul class="list-group list-group-flush">
      <% clickListing.reviews.forEach(rev => { %>
        <li class="list-group-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>@<%= rev.author.username %></strong>
              <span class="ms-2 text-warning">
                <% for (let i = 1; i <= 5; i++) { %>
                  <% if (i <= rev.rating) { %>
                    <i class="fa-solid fa-star"></i>
                  <% } else { %>
                    <i class="fa-regular fa-star"></i>
                  <% } %>
                <% } %>
              </span>
              <p class="mb-1"><%= rev.comments %></p>
              <small class="text-muted">Created: <%= rev.createdAt.toISOString().split('T')[0] %></small>
            </div>
            <% if (currUser && (currUser._id.equals(rev.author._id) || currUser.role==='admin')) { %>
              <form action="/listing/<%= clickListing._id %>/reviews/<%= rev._id %>/delete?_method=DELETE"
                method="POST" onsubmit="return confirm('Delete this review?');">
                <button class="btn btn-sm btn-outline-danger"><i class="fa-solid fa-trash"></i></button>
              </form>
            <% } %>
          </div>
        </li>
      <% }) %>
    </ul>
  </div>
    <!-- Google Map -->
  <% if (clickListing.latitude && clickListing.longitude) { %>
    <div class="container my-5 fade-in">
      <h4><i class="bi bi-geo-alt-fill me-2"></i>Shop Location</h4>
      <div id="map"></div>
    </div>
  <% } %>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const form = document.getElementById("uploadForm");
    const uploadLoader = document.getElementById("upload-loader");
    if (form) {
      form.addEventListener("submit", function () {
        uploadLoader.style.display = "flex";
      });
    }
  </script>
   
<script
  src="https://maps.googleapis.com/maps/api/js?key=<%=apiKey%>&libraries=marker&v=beta&callback=initMap"
  async defer>
</script>


  <script>
    function initMap() {
      const position = { lat: <%= clickListing.latitude %>, lng: <%= clickListing.longitude %> };

      const map = new google.maps.Map(document.getElementById("map"), {
        center: position,
        zoom: 15,
        mapId: "DEMO_MAP_ID" // you can create a styled map ID in Google Cloud console if you want custom colors
      });

      // Advanced Marker
      new google.maps.marker.AdvancedMarkerElement({
        map,
        position: position,
        title: "<%= clickListing.itemName %>"
      });
    }

    window.initMap = initMap;
  </script>
  </body>
</html>
