<%- include('./components/header.ejs') %>
  <!DOCTYPE html>
  <html lang="en">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Listing Review</title>
    <style>
      /* fade-in animation */
      .fade-in {
        animation: fadeIn 0.6s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* remove any “card” look: plain white background & no shadow */
/* remove blocky look */
.plain-box {
  background: transparent;  /* no white box */
  padding: 0;               /* remove padding */
  margin: 0 auto;           /* center content */
  border: none;             /* no border */
  border-radius: 0;         /* no rounded edges */
}

/* make image take full width */
.image-full {
  width: 100%;
  text-align: center;
  margin-bottom: 1rem;
}

.image-full img {
  width: 100%;
  height: auto;
  max-height: 70vh;   /* use screen height for responsiveness */
  object-fit: contain; 
  border-radius: 0;   /* no rounded corners */
}
      #upload-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(255, 255, 255, 0.8);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 6px solid #ccc;
        border-top: 6px solid crimson;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }
      .image-full {
  width: 100%;
  text-align: center;
}

.image-full img {
  width: 100%;
  height: auto;
  max-height: 500px;  /* optional: keep max height */
  object-fit: contain; /* prevents image cutoff */
  border-radius: 8px;
}

.star-rating {
  display: flex;
  flex-direction: row-reverse;
  justify-content: flex-end;
}

.star-rating input {
  display: none;
}

.star-rating label {
  font-size: 2rem;
  color: #ccc;
  cursor: pointer;
  transition: color 0.2s;
}

.star-rating input:checked ~ label,
.star-rating label:hover,
.star-rating label:hover ~ label {
  color: #f39c12; /* Flipkart yellow */
}

    </style>
  </head>

  <body class="bg-light">
  <div id="upload-loader" style="display: none;">
  <div class="spinner"></div>
</div>

<div class="container-fluid py-4 fade-in">
  <div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">

      <!-- Listing Details (full-width, no card look) -->
      <div class="plain-box">
        
        <!-- Full-width Image -->
        <div class="image-full">
          <img src="<%= clickListing.image.url %>" alt="Listing Image">
        </div>

        <!-- Title -->
        <h2 class="h3 mb-2">
          <i class="bi bi-house-door-fill me-2"></i>
          <%= clickListing.title %>
        </h2>

        <!-- Owner -->
        <p class="text-muted small mb-2">
          Owned by: <strong><%= clickListing.owner.username %></strong>
        </p>

        <!-- Description -->
        <p><b>Description:</b> <%= clickListing.description %></p>

        <!-- Price -->
        <p class="h4 text-danger">₹ <%= clickListing.price %></p>

        <!-- User Buttons -->
        <% if (currUser && currUser.role==='user' ) { %>
          <div class="mt-3 d-flex flex-wrap gap-2">
            <form action="/buy/<%= clickListing._id %>" method="POST" class="d-inline">
              <button type="submit" class="btn btn-success w-auto">Buy Now</button>
            </form>

            <form action="/cart/add/<%= clickListing._id %>" method="POST" class="d-inline">
              <button type="submit" class="btn btn-warning w-auto">Add to Cart</button>
            </form>
          </div>
        <% } %>

        <!-- Owner/Admin Buttons -->
        <% if (currUser && (currUser._id.equals(clickListing.owner._id) || currUser.role==='admin')) { %>
          <div class="d-inline">
            <a href="/listing/<%= clickListing._id %>/edit" class="btn btn-outline-primary w-auto">
              <i class="bi bi-trash-fill"></i> Edit
            </a>

            <form id="uploadForm" action="/listing/<%= clickListing._id %>?_method=DELETE" method="POST"
              class="d-inline" onsubmit="return confirm('Delete this listing?');">
              <button class="btn btn-outline-danger w-auto">
                <i class="bi bi-trash-fill"></i> Delete
              </button>
            </form>
          </div>
        <% } %>

      </div>
    </div>
  </div>
</div>


<!-- Ratings Summary -->
<div class="plain-box fade-in mb-4">
  <h4><i class="bi bi-star-fill text-warning me-2"></i>Ratings & Reviews</h4>
  <div class="d-flex align-items-center mb-3">
    <h1 class="me-3"><%= avgRating.toFixed(1)  || "0.0" %>★</h1>
    <div>
      <p class="mb-0 text-muted"><%= clickListing.reviews.length %> Reviews</p>
    </div>
  </div>

  <% [5,4,3,2,1].forEach(star => { 
       const count = clickListing.reviews.filter(r => r.rating === star).length;
       const percent = clickListing.reviews.length 
       ? (count / clickListing.reviews.length * 100).toFixed(1) 
       : 0;
       %>
       <div class="d-flex align-items-center mb-1">
        <span class="me-2"><%= star %>★</span>
        <div class="progress flex-grow-1" style="height: 6px;">
        <div class="progress-bar bg-warning" role="progressbar" style="width: <%= percent %>%"></div>
        </div>
        <span class="ms-2"><%= count %></span>
        </div>
        <% }) %>
        </div>
        <!-- Review Form -->
        <% if (currUser) { %>
          <div class="plain-box fade-in">
            <h4><i class="bi bi-chat-square-text me-2"></i>Leave a Review</h4>
            <form action="/listing/<%= clickListing._id %>/reviews" method="POST">
              <div class="mb-3">
                <label class="form-label">Rating</label>
                <div class="star-rating">
                  <% for (let i = 5; i >= 1; i--) { %>
                    <input type="radio" id="star<%= i %>" name="review[rating]" value="<%= i %>" required />
                    <label for="star<%= i %>" title="<%= i %> stars">&#9733;</label>
                  <% } %>
                </div>
              </div>
              <div class="mb-3">
                <label for="comments" class="form-label">Comments</label>
                <textarea id="comments" name="review[comments]" class="form-control" rows="4"
                  placeholder="Write your review..." required></textarea>
              </div>
              <button type="submit" class="btn btn-success">
                <i class="bi bi-send-fill me-1"></i> Submit
              </button>
            </form>
          </div>
        <% } %>
        
  <!-- All Reviews -->
  <div class="plain-box fade-in">
    <h4><i class="bi bi-chat-dots-fill me-2"></i>User Reviews</h4>
    <ul class="list-group list-group-flush">
      <% clickListing.reviews.forEach(rev => { %>
        <li class="list-group-item">
        <div class="d-flex justify-content-between">
          <div>
            <strong>@<%= rev.author.username %></strong>

            <!-- Show rating as stars -->
            <span class="ms-2 text-warning">
              <% for (let i = 1; i <= 5; i++) { %>
                <% if (i <= rev.rating) { %>
                  <i class="fa-solid fa-star"></i> <!-- filled star -->
                <% } else { %>
                  <i class="fa-regular fa-star"></i> <!-- empty star -->
                <% } %>
              <% } %>
            </span>

            <p class="mb-1"><%= rev.comments %></p>
            <small class="text-muted">Created: <%= rev.createdAt.toISOString().split('T')[0] %></small>
          </div>

          <% if (currUser && (currUser._id.equals(rev.author._id) || currUser.role==='admin')) { %>
            <form action="/listing/<%= clickListing._id %>/reviews/<%= rev._id %>/delete?_method=DELETE"
              method="POST" onsubmit="return confirm('Delete this review?');">
              <button class="btn btn-sm btn-outline-danger"><i class="fa-solid fa-trash"></i></button>
            </form>
          <% } %>
        </div>
      </li>
    <% }) %>
  </ul>
</div>


      </div>
    </div>
    </div>

    <!-- Bootstrap JS if needed -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>



      const form = document.getElementById("uploadForm");
      const uploadLoader = document.getElementById("upload-loader");

      form.addEventListener("submit", function () {
        uploadLoader.style.display = "flex";
      });

    </script>
<!-- <script>
  const productId = "<%= clickListing._id %>";
  fetch(`/cart/add/${productId}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ quantity: 1 })
  });
</script> -->

  </body>

  </html>