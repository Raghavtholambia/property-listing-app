<head>
  <style>
    :root {
      --primary-dark: #1a1a1a;
      --primary-medium: #2d2d2d;
      --accent-gold: #d4af37;
      --accent-light: #f0e5d8;
      --bg-cream: #fafaf8;
      --text-primary: #1a1a1a;
      --text-secondary: #6b6b6b;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--bg-cream);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: var(--text-primary);
      line-height: 1.6;
    }

    /* Premium Header Bar */
    .premium-header {
      background: #fff;
      border-bottom: 1px solid #e8e8e8;
      padding: 1rem 0;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
    }

    .breadcrumb-premium {
      display: flex;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .breadcrumb-premium a {
      color: var(--text-secondary);
      text-decoration: none;
      transition: color 0.3s;
    }

    .breadcrumb-premium a:hover {
      color: var(--accent-gold);
    }

    /* Main Layout */
    .product-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    .product-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    @media (min-width: 992px) {
      .product-grid {
        grid-template-columns: 1fr 400px;
      }
    }

    /* Image Gallery */
    .gallery-section {
      background: #fff;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: var(--shadow-sm);
    }

    .main-image-container {
      position: relative;
      width: 100%;
      height: 500px;
      background: #f8f8f8;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 1rem;
      max-height: 30vh;
    }

    .main-image-container img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: transform 0.5s ease;
    }

    .main-image-container:hover img {
      transform: scale(1.05);
    }

    .zoom-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      font-size: 0.875rem;
      backdrop-filter: blur(10px);
    }

    /* Product Info */
    .product-info {
      background: #fff;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: var(--shadow-sm);
      margin-top: 2rem;
    }

    .category-badge {
      display: inline-block;
      background: var(--accent-light);
      color: var(--text-primary);
      padding: 0.375rem 1rem;
      border-radius: 25px;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 1rem;
    }

    .product-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-dark);
      margin-bottom: 1rem;
      line-height: 1.2;
    }

    .owner-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #e8e8e8;
    }

    .owner-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-gold), #e5c180);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 600;
    }

    .price-section {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary-medium));
      color: #fff;
      padding: 1.5rem;
      border-radius: 12px;
      margin: 1.5rem 0;
    }

    .price-label {
      font-size: 0.875rem;
      opacity: 0.8;
      margin-bottom: 0.25rem;
    }

    .price-amount {
      font-size: 2.5rem;
      font-weight: 700;
    }

    .price-period {
      font-size: 1rem;
      opacity: 0.9;
    }

    /* Sticky Rental Card */
    .rental-card {
      background: #fff;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: var(--shadow-lg);
      border: 1px solid #e8e8e8;
      position: sticky;
      top: 100px;
    }

    .rental-card-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      color: var(--primary-dark);
    }

    .form-group-modern {
      margin-bottom: 1.5rem;
    }

    .form-label-modern {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      display: block;
    }

    .form-control-modern {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #e8e8e8;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s;
      background: #fff;
    }

    .form-control-modern:focus {
      outline: none;
      border-color: var(--accent-gold);
      box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
    }

    .quantity-selector {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .qty-btn {
      width: 40px;
      height: 40px;
      border: 2px solid #e8e8e8;
      background: #fff;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 1.25rem;
    }

    .qty-btn:hover {
      border-color: var(--accent-gold);
      background: var(--accent-light);
    }

    .qty-input {
      width: 60px;
      text-align: center;
      padding: 0.5rem;
      border: 2px solid #e8e8e8;
      border-radius: 8px;
      font-weight: 600;
    }

    .total-section {
      background: var(--accent-light);
      padding: 1.5rem;
      border-radius: 12px;
      margin: 1.5rem 0;
    }

    .total-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .total-amount {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .btn-rent-now {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, var(--accent-gold), #e5c180);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
    }

    .btn-rent-now:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(212, 175, 55, 0.4);
    }

    /* Mobile Rent Button */
    .mobile-rent-bar {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      padding: 1rem 1.5rem;
      box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    @media (max-width: 991px) {
      .mobile-rent-bar {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .rental-card {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 2000;
        border-radius: 0;
        overflow-y: auto;
        transform: translateY(100%);
        transition: transform 0.3s;
      }

      .rental-card.active {
        transform: translateY(0);
      }

      .mobile-price {
        flex: 1;
      }

      .mobile-price-amount {
        font-size: 1.5rem;
        font-weight: 700;
      }
    }

    .close-modal {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: #f0f0f0;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: none;
    }

    @media (max-width: 991px) {
      .close-modal {
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }

    /* Reviews Section */
    .reviews-section {
      background: #fff;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: var(--shadow-sm);
      margin-top: 2rem;
    }

    .rating-overview {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 2rem;
      align-items: center;
      padding-bottom: 2rem;
      border-bottom: 1px solid #e8e8e8;
      margin-bottom: 2rem;
    }

    .rating-score {
      text-align: center;
    }

    .rating-number {
      font-size: 4rem;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .rating-stars {
      color: var(--accent-gold);
      font-size: 1.5rem;
      margin: 0.5rem 0;
    }

    .rating-count {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .rating-bars {
      flex: 1;
    }

    .rating-bar-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }

    .bar-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      width: 60px;
    }

    .bar-container {
      flex: 1;
      height: 8px;
      background: #e8e8e8;
      border-radius: 4px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-gold), #e5c180);
      border-radius: 4px;
      transition: width 0.6s ease;
    }

    .bar-count {
      font-size: 0.875rem;
      color: var(--text-secondary);
      width: 40px;
      text-align: right;
    }

    .review-item {
      padding: 1.5rem;
      border-radius: 12px;
      background: #fafafa;
      margin-bottom: 1rem;
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .review-author {
      font-weight: 600;
      color: var(--primary-dark);
    }

    .review-stars {
      color: var(--accent-gold);
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    .btn-edit,
    .btn-delete {
      flex: 1;
      padding: 0.875rem;
      border-radius: 8px;
      border: 2px solid var(--primary-dark);
      background: #fff;
      color: var(--primary-dark);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-delete {
      border-color: #dc3545;
      color: #dc3545;
    }

    .btn-edit:hover {
      background: var(--primary-dark);
      color: #fff;
    }

    .btn-delete:hover {
      background: #dc3545;
      color: #fff;
    }

    /* Map Section */
    .map-section {
      background: #fff;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: var(--shadow-sm);
      margin-top: 2rem;
    }

    #map {
      width: 100%;
      height: 400px;
      border-radius: 12px;
    }

    .section-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary-dark);
      margin-bottom: 1.5rem;
    }

    /* Stock Badge */
    .stock-badge {
      display: inline-block;
      padding: 0.375rem 0.75rem;
      background: #e8f5e9;
      color: #2e7d32;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      margin-top: 0.5rem;
    }

    /* Fade in animation */
    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .product-title {
        font-size: 1.75rem;
      }

      .main-image-container {
        height: 350px;
      }

      .rating-overview {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .rating-number {
        font-size: 3rem;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

</head>

<body>
  <div id="lockStatus" class="text-warning small mt-2"></div>

  <div class="premium-header">
    <div class="container-fluid" style="max-width:1400px">
      <div class="breadcrumb-premium">
        <a href="/">Home</a><span>/</span>
        <a href="/store/<%=clickListing.owner._id %>">shop</a><span>/</span>
        <span>
          <%= clickListing.itemName %>
        </span>
      </div>
    </div>
  </div>

  <div class="product-container">
    <div class="product-grid">
      <div>
        <div class="gallery-section fade-in">
          <div class="main-image-container">
            <img src="<%= clickListing.image.url %>" alt="<%= clickListing.itemName %>">
          </div>
        </div>

        <div class="product-info fade-in">
          <span class="category-badge"><i class="fas fa-tag"></i>
            <%= clickListing.category %>
          </span>
          <h1 class="product-title">
            <%= clickListing.itemName %>
          </h1>

          <div class="price-section">
            <div class="price-label">Daily Rental Price</div>
            <div>
              <span class="price-amount">‚Çπ<%= clickListing.pricePerDay.toLocaleString("en-IN") %></span>
              <span class="price-period">/ day</span>
            </div>
          </div>

          <p class="text-muted">
            <%= clickListing.description %>
          </p>
        </div>

        <% if (clickListing.latitude && clickListing.longitude) { %>
          <div class="map-section fade-in">
            <h2 class="section-title">Item Location</h2>
            <div id="map" style="height: 300px; width: 100%; border-radius: 12px;"></div>
          </div>
          <% } %>
      </div>

      <div>
        <div class="rental-card fade-in" id="rentalCard">
          <form action="/cart/add/<%= clickListing._id %>" method="POST" id="rentForm">

            <div class="form-group-modern">
              <label class="form-label-modern">Rental Dates</label>
              <input type="text" class="form-control-modern" id="rentCalendar" placeholder="Select rental dates"
                readonly>
              <input type="hidden" name="startDate" id="hiddenStartDate">
              <input type="hidden" name="endDate" id="hiddenEndDate">
            </div>

            <div class="form-group-modern">
              <label class="form-label-modern">Quantity</label>
              <div class="quantity-selector" style="display: flex; align-items: center; gap: 10px;">
                <button type="button" class="qty-btn" id="qtyMinus" style="cursor: pointer;">‚àí</button>
                <input type="number" class="qty-input" id="quantity" name="quantity" value="1" min="1"
                  max="<%= clickListing.stock || 5 %>" readonly style="width: 50px; text-align: center; border: none;">
                <button type="button" class="qty-btn" id="qtyPlus" style="cursor: pointer;">+</button>
              </div>
            </div>

            <div class="total-section">
              <div class="total-label">Estimated Total</div>
              <div class="total-amount" id="totalAmount">‚Çπ0</div>
            </div>

            <button type="submit" class="btn-rent-now">
              <i class="fas fa-shopping-cart"></i> Add to Cart
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

<script>
  /**********************
   * GLOBAL STATE
   **********************/
  const listingId = "<%= clickListing._id %>";
  const pricePerDay = Number("<%= clickListing.pricePerDay %>");

  let flatpickrInstance = null;
  let currentLock = null;
  let disabledRangesFromDB = [];
  let tempLocks = [];

  /**********************
   * INIT CALENDAR
   **********************/
  fetch(`/api/bookings/listing/${listingId}`)
    .then(res => res.json())
    .then(bookings => {
      disabledRangesFromDB = bookings.map(b => ({
        from: new Date(b.startDate),
        to: new Date(b.endDate)
      }));

      flatpickrInstance = flatpickr("#rentCalendar", {
        mode: "range",
        minDate: "today",
        dateFormat: "Y-m-d",
        disable: disabledRangesFromDB,
        onChange: onDateChange
      });
    })
    .catch(err => console.error("Calendar Load Error:", err));

  /**********************
   * DATE CHANGE HANDLER
   **********************/
  async function onDateChange(selectedDates) {
    if (selectedDates.length !== 2) return;

    const [start, end] = selectedDates;
    const quantity = parseInt(document.getElementById("quantity").value);

    try {
      // üîì Unlock previous lock
      if (currentLock) {
        await unlockDates(currentLock.start, currentLock.end);
        currentLock = null;
      }

      // üîí Lock new dates
      const data = await lockDates(start, end, quantity);

      if (!data.success) {
        throw new Error(data.reason);
      }

      currentLock = {
        start: formatDate(start),
        end: formatDate(end)
      };

      calculateTotal(start, end);
      showTempLockMessage();

    } catch (err) {
      console.warn("Lock failed:", err.message);
      flatpickrInstance.clear();
      alert("Selected dates are not available for requested quantity");
    }
  }

  /**********************
   * LOCK / UNLOCK
   **********************/
async function lockDates(start, end, quantity) {
  const res = await fetch("/api/lock-dates", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      listingId,
      startDate: formatDate(start),
      endDate: formatDate(end),
      quantity
    })
  });

  const data = await res.json();

  if (!res.ok) {
    throw new Error(data.message || "Lock failed");
  }

  return data;
}

async function unlockDates(startDate, endDate) {
  try {
    await fetch("/api/unlock-dates", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ listingId, startDate, endDate })
    });
  } catch (e) {
    console.warn("Unlock failed", e);
  }
}


  function formatDate(date) {
    return date.toISOString().split("T")[0];
  }

  /**********************
   * PRICE CALC
   **********************/
  function calculateTotal(start, end) {
    const diffTime = Math.abs(end - start);
    const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) || 1;
    const qty = parseInt(document.getElementById("quantity").value) || 1;
    const total = days * pricePerDay * qty;

    document.getElementById("totalAmount").textContent =
      "‚Çπ" + total.toLocaleString("en-IN");
  }

  function showTempLockMessage() {
    document.getElementById("lockStatus").innerText =
      "‚è≥ Dates reserved for 5 minutes. Complete booking to confirm.";
  }
</script>

<script>
  /**********************
   * QUANTITY HANDLING
   **********************/
  (function () {
    const qtyInput = document.getElementById("quantity");
    const qtyPlus = document.getElementById("qtyPlus");
    const qtyMinus = document.getElementById("qtyMinus");

    async function relockWithNewQuantity() {
      if (
        !flatpickrInstance ||
        flatpickrInstance.selectedDates.length !== 2 ||
        !currentLock
      ) return;

      const [start, end] = flatpickrInstance.selectedDates;
      const quantity = parseInt(qtyInput.value);

      try {
        await unlockDates(currentLock.start, currentLock.end);
        const data = await lockDates(start, end, quantity);

        if (!data.success) {
          throw new Error();
        }

        currentLock = {
          start: formatDate(start),
          end: formatDate(end)
        };

        calculateTotal(start, end);

      } catch {
        alert("Not enough stock for updated quantity");
        qtyInput.value = quantity - 1;
      }
    }

    qtyPlus?.addEventListener("click", async () => {
      qtyInput.value = parseInt(qtyInput.value) + 1;
      await relockWithNewQuantity();
    });

    qtyMinus?.addEventListener("click", async () => {
      if (parseInt(qtyInput.value) > 1) {
        qtyInput.value = parseInt(qtyInput.value) - 1;
        await relockWithNewQuantity();
      }
    });
  })();
</script>


<script>
  /**********************
   * SOCKET TEMP LOCKS
   **********************/
  try {
    const socket = io();
    socket.emit("joinListing", listingId);

  socket.on("datesLocked", ({ startDate, endDate }) => {
  // Ignore our own lock
  if (
    currentLock &&
    currentLock.start === startDate &&
    currentLock.end === endDate
  ) {
    return;
  }

  tempLocks.push({
    from: new Date(startDate),
    to: new Date(endDate)
  });

  flatpickrInstance?.set("disable", [
    ...disabledRangesFromDB,
    ...tempLocks
  ]);
});

  } catch (e) {
    console.warn("Socket.io not available");
  }
</script>


  <script src="https://maps.googleapis.com/maps/api/js?key=<%=apiKey%>&libraries=marker&v=beta&callback=initMap" async
    defer></script>
  <script>
    function initMap() {
      const pos = { lat: <%= clickListing.latitude %>, lng: <%= clickListing.longitude %> };
      const map = new google.maps.Map(document.getElementById("map"), { center: pos, zoom: 15, mapId: "DEMO_MAP_ID" });
      new google.maps.marker.AdvancedMarkerElement({ map, position: pos, title: "<%= clickListing.itemName %>" });
    }
  </script>
</body>