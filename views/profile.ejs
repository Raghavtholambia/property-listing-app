
  <style>
    body {
      background: #f7f7f7;
      font-family: "Poppins", sans-serif;
    }

    .profile-card {
      max-width: 700px;
      margin: 50px auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: transform 0.2s ease;
    }

    .profile-card:hover {
      transform: scale(1.01);
    }

    .profile-header {
      background: linear-gradient(135deg, #dc3545, #000);
      color: white;
      text-align: center;
      padding: 40px 20px;
      position: relative;
    }

    .profile-img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid white;
      object-fit: cover;
      position: absolute;
      bottom: -60px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #fff;
    }

    .profile-body {
      padding: 80px 30px 30px;
    }

    .profile-body .form-control {
      border-radius: 10px;
      box-shadow: none;
      transition: all 0.3s;
    }

    .profile-body .form-control:focus {
      border-color: #dc3545;
      box-shadow: 0 0 5px rgba(220, 53, 69, 0.4);
    }

    .save-btn {
      background: linear-gradient(135deg, #dc3545, #000);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 50px;
      transition: all 0.3s;
    }

    .save-btn:hover {
      background: linear-gradient(135deg, #000, #dc3545);
      transform: translateY(-2px);
    }

    .edit-icon {
      position: absolute;
      bottom: -10px;
      right: 46%;
      background: white;
      border-radius: 50%;
      padding: 6px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      transition: 0.3s;
    }

    .edit-icon:hover {
      background: #f0f0f0;
      transform: scale(1.1);
    }

    @media (max-width: 576px) {
      .profile-card {
        margin: 20px;
      }
    }
  </style>
</head>

<%- include('./components/header.ejs') %>

<body>
  <h1>coins: <%=  currUser.ppCoins %> :: </h1>
  <hr><h1><%= currUser.badges %></h1>
  <h1><%= currUser.spCoins %></h1>
  <hr>
  <div class="profile-card container mt-4 mb-5">
    <!-- üîπ Header -->
    <div class="profile-header text-center mb-4">
      <h3><%= currUser.username %></h3>
      <p class="mb-1"><i class="fa-solid fa-user-shield"></i> <%= currUser.role %></p>
      <p class="small mb-0">Member since: <%= new Date(currUser.createdAt).toLocaleDateString() %></p>

      <!-- Profile Image Upload -->
      <form id="imageForm" action="/profile/upload-profile-image" method="POST" enctype="multipart/form-data">
        <div class="position-relative d-inline-block mt-3">
          <img
            src="<%= currUser.profileImage || '/images/default-user.png' %>"
            alt="Profile Picture"
            class="profile-img rounded-circle border shadow"
            id="profileImagePreview"
            style="width:130px; height:130px; object-fit:cover;"
          />
          <label for="profileImage" class="edit-icon position-absolute bottom-0 end-0 bg-light p-2 rounded-circle shadow-sm">
            <i class="fa fa-camera text-danger"></i>
          </label>
          <input
            type="file"
            name="profileImage"
            id="profileImage"
            accept="image/*"
            style="display:none"
            onchange="document.getElementById('imageForm').submit();"
          />
        </div>
      </form>
    </div>

    <!-- üîπ Body -->
    <div class="profile-body">
      <form action="/profile/update-profile" method="POST">

        <div class="mb-3">
          <label class="form-label fw-semibold">Full Name*</label>
          <input type="text" class="form-control" name="fullName" value="<%= currUser.fullName || '' %>" required />
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Bio</label>
          <textarea class="form-control" name="bio" rows="3" placeholder="Tell us about yourself..."><%= currUser.bio || '' %></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Phone*</label>
          <input type="text" class="form-control" name="phone" value="<%= currUser.phone || '' %>" required />
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold">Address*</label>
          <input type="text" id="address" class="form-control" name="address" value="<%= currUser.address || '' %>" required />
        </div>

        <!-- Google Map -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Delivery Location</label>
          <div id="map" style="height: 300px; width: 100%; border-radius: 10px;"></div>
          <small class="text-muted">üìç Marker shows your detected location. Drag to adjust.</small>
        </div>

        <!-- Hidden inputs -->
        <input type="hidden" id="latitude" name="latitude" value="<%= currUser.latitude || '' %>">
        <input type="hidden" id="longitude" name="longitude" value="<%= currUser.longitude || '' %>">

        <!-- Button to detect location -->
        <button id="useMyLocation" type="button" class="btn btn-outline-danger mt-3 w-100">
          üìç Use My Current Location
        </button>

        <div class="text-center">
          <button type="submit" class="btn btn-danger btn-lg mt-3 shadow">
            <i class="fa-solid fa-floppy-disk me-2"></i> Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>



  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=<%= apiKey %>&libraries=places"></script>

  <script>
    function initMap() {
      const savedLat = parseFloat("<%= currUser.latitude %>");
      const savedLng = parseFloat("<%= currUser.longitude %>");
      const hasSavedLocation = !isNaN(savedLat) && !isNaN(savedLng);

      const defaultLocation = { lat: 28.6139, lng: 77.2090 }; // Delhi fallback
      const initialLocation = hasSavedLocation ? { lat: savedLat, lng: savedLng } : defaultLocation;

      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: initialLocation,
      });

      const marker = new google.maps.Marker({
        position: initialLocation,
        map,
        draggable: true,
      });

      const geocoder = new google.maps.Geocoder();

      function updateLocation(lat, lng) {
        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lng;
        geocoder.geocode({ location: { lat, lng } }, (results, status) => {
          if (status === "OK" && results[0]) {
            document.getElementById("address").value = results[0].formatted_address;
          }
        });
      }

      // If user already has a saved location
      if (hasSavedLocation) {
        updateLocation(savedLat, savedLng);
      } else {
        document.getElementById("address").value = "No location saved. Please detect your current location.";
      }

      // Update when marker is dragged
      google.maps.event.addListener(marker, "dragend", function () {
        const pos = marker.getPosition();
        updateLocation(pos.lat(), pos.lng());
      });

      // Handle ‚ÄúUse My Current Location‚Äù
      const currLocBtn = document.getElementById("useMyLocation");
      currLocBtn.addEventListener("click", function (event) {
        event.preventDefault();
        console.log("üìç Button clicked!");
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              console.log("‚úÖ Location fetched:", pos.coords);
              const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
              map.setCenter(loc);
              marker.setPosition(loc);
              updateLocation(loc.lat, loc.lng);
            },
            (err) => {
              console.error("‚ùå Location error:", err);
              alert("Unable to fetch your location. Please allow location access.");
            }
          );
        } else {
          alert("Geolocation not supported by your browser.");
        }
      });
    }

    // Initialize map when page is loaded
    window.addEventListener("load", initMap);
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>


</html>
